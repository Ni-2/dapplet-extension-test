# Solution Architecture

## Glossary

**Dapplet Extension** - 

**Background** - 

**ContentScript** - 

**Popup** - 

**Options** -

**Контекст** - 

**Adapter** -

**Feature** - 

**Точка вставки** - 

**Виджет** - 

**Дополненный контекст** - 

**Augmentation Server** -

## Dapplet Extension

Диаграмма ниже описывает структуру расширения и его внешнее окружение.

![](images/dapplet-extension.png)

Общая схема работы:

1. Background загружает модули из децентрализованного хранилища.
2. Background кэширует модули во внутреннее хранилище браузера и читает настройки.
3. Пользователь включает необходимые ему Features, доступные для текущей страницы, через Popup.
4. contentscript при загрузке контекстной страницы получает тексты скриптов модулей от Background
5. contentscript в ходе исполнения модулей парсит из веб-страницы контекстную информацию и вставляет в страницу кнопки (widgets).
6. При необходимости из внешнего API (например, через WebSocket или HTTP) поставляются дополнительные данные для расширения контекста.

## Injectable Modules

Для разработки модулей предлагается архитектура, позволяющая разделить функциональную ответственность в отдельные модули:

* Адаптер (adapter) - "низкоуровневое" взаимодействие с DOM страницы;
* Возможность (feature) - "высокоуровневое" описание бизнес-кейсов.

Целью такого разделения явялется упрощённая разработка виджетов для реализации бизнес-кейсов без необходимости погружения до уровня DOM веб-страницы. 

Разработчик Feature оперируёт только высокоуровневыми классами, предоставляемыми адаптером, которые инкапсулируют всю логику взаимодействия с DOM веб-страницы. 

Разработчик Feature получает возможность внедрять виджеты на веб-страницу без знания того, как устроен её DOM. Это позволяет полностью сфокусироваться на реализации бизнес-кейсов.

Задачами модулей-адаптеров являются:

1. Парсинг контекстной информации из DOM веб-страницы.
2. Определение точек вставки, достпуных на веб-странице.
3. Определение типов виджетов, доступных для размещения в каждой конкретной точке вставки.
4. Внедрение виджетов в DOM веб-страницы.
5. Наблюдение за изменениями DOM веб-страницы.

Задачами модулей-возможностей явялются:

1. Конфигурация виджетов и их привязка к конкретной точке вставки.
2. Описание поведения виджетов при взаимодействии с ними.
3. Конфигурация точки входа во внешний API для загрузки дополненного контекста.

### Зависимости между модулями

На диаграмме ниже показан пример того, как могут выглядеть зависимости между модулями.

Feature-модули ```twitter-feature-1``` и ```twitter-feature-2``` используют адаптер ```twitter-adapter``` для внедрения виджетов. Модуль ```twitter-adapter``` взаимодействует с DOM веб-страницы. 

Возможно использование общих библиотек для вынесения повторяющегося кода в отдельные модули. На диаграмме ```twitter-adapter``` использует модуль ```common-lib```.

![](images/typescript-examples.png) 

Примеры такой реализации можно найти в репозитории [typescript-examples](https://github.com/dapplets/typescript-examples).